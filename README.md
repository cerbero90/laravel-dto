# Laravel DTO

[![Required Laravel Version][ico-laravel]][link-packagist]
[![Required PHP Version][ico-php]][link-packagist]
[![Latest Version on Packagist][ico-version]][link-packagist]
[![Software License][ico-license]](LICENSE.md)
[![Build Status][ico-travis]][link-travis]
[![Coverage Status][ico-scrutinizer]][link-scrutinizer]
[![Quality Score][ico-code-quality]][link-code-quality]
[![Total Downloads][ico-downloads]][link-downloads]

Laravel DTO integrates [DTO][link-dto], a package inspired by [Lachlan Krautz][link-lachlan]' excellent [data-transfer-object][link-data-transfer-object], with the functionalities of Laravel.

A data transfer object (DTO) is an object that carries data between processes. DTO does not have any behaviour except for storage, retrieval, serialization and deserialization of its own data. DTOs are simple objects that should not contain any business logic but rather be used for transferring data.

Below are explained the advantages brought by this package in a Laravel application. In order to discover all the features of DTO, please refer to the [full DTO documentation][link-dto].


## Install

Via Composer:

```bash
composer require cerbero/laravel-dto
```

To customize some aspects of this package, the `config/dto.php` file can optionally be generated via:

```bash
php artisan vendor:publish --tag=dto
```


## Usage

* [Generate DTOs](#generate-dtos)
* [Instantiate a DTO](#instantiate-a-dto)
* [Resolve a DTO](#resolve-a-dto)
* [Convert into DTO](#convert-into-dto)
* [Convert into array](#convert-into-array)
* [Listen to events](#listen-to-events)
* [Support for macros](#support-for-macros)
* [DTO debugging](#dto-debugging)


### Generate DTOs

DTOs for Eloquent models can be automatically generated by running the following Artisan command:

```bash
php artisan make:dto App/User
```

The database table of the specified model is scanned to populate the DTO properties. Furthermore, if the model has relationships, a DTO is also generated for each related model. For example, if our `User` model looks like:

```php
class User extends Model
{
    public function posts()
    {
        return $this->hasMany('App\Post');
    }
}
```

The DTOs `App\Dtos\UserData` and `App\Dtos\PostData` are generated like so:

```php
use Cerbero\LaravelDto\Dto;
use Carbon\Carbon;

use const Cerbero\Dto\PARTIAL;
use const Cerbero\Dto\IGNORE_UNKNOWN_PROPERTIES;

/**
 * The data transfer object for the User model.
 *
 * @property int $id
 * @property string $name
 * @property Carbon $createdAt
 * @property Carbon $updatedAt
 * @property PostData[] $posts
 */
class UserData extends Dto
{
    /**
     * The default flags.
     *
     * @var int
     */
    protected static $defaultFlags = PARTIAL | IGNORE_UNKNOWN_PROPERTIES;
}

/**
 * The data transfer object for the Post model.
 *
 * @property int $id
 * @property string $content
 * @property int $userId
 * @property Carbon $createdAt
 * @property Carbon $updatedAt
 * @property UserData $user
 */
class PostData extends Dto
{
    /**
     * The default flags.
     *
     * @var int
     */
    protected static $defaultFlags = PARTIAL | IGNORE_UNKNOWN_PROPERTIES;
}
```

By default, DTOs are generated in the `Dtos` directory which is created where models are. For example the DTO for `App\User` is generated as `App\Dtos\UserData` and the DTO for `App\Users\User` is generated as `App\Users\Dtos\UserData`.

To change either the location or the suffix `Data` of generated DTOs, we can create a DTO qualifier by implementing the interface `DtoQualifierContract` and replace the default qualifier in `config/dto.php`. The example below qualifies a DTO in the directory of the model and adds the suffix `Dto`:

```php
use Cerbero\LaravelDto\DtoQualifierContract;

class MyDtoQualifier implements DtoQualifierContract
{
    public function qualify(string $model): string
    {
        return $model . 'Dto';
    }
}

// in config/dto.php
return [
    'qualifier' => MyDtoQualifier::class,
];
```

Finally, if a model has already its own DTO generated, we can overwrite it with the option `--force` or `-f`:

```bash
php artisan make:dto App/User --force
```


### Instantiate a DTO

In addition to the [traditional ways to instantiate a DTO][link-dto-init], Laravel DTO provides handy methods to create a new instance of DTO from HTTP requests, Eloquent models or other common interfaces present in Laravel.

For example `UserData` can be instantiated from an HTTP request by calling the method `fromRequest()`:

```php
use App\Dtos\UserData;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;

class UserController extends Controller
{
    public function store(Request $request)
    {
        $dto = UserData::fromRequest($request);
    }
}
```

The request passed to the method `fromRequest()` is optional: if not provided, the current application request is used to instantiate `UserData`.

By default the flags [PARTIAL][link-flag-partial] and [IGNORE_UNKNOWN_PROPERTIES][link-flag-ignore] are applied to the DTO when it is instantiated from a request. [Additional flags][link-flags] can be passed as second parameter to further customize the behaviour of the DTO.

---

To instantiate a DTO from an Eloquent model, we can call the method `fromModel()`:

```php
$user = new User(['name' => 'Phil']);

$dto = UserData::fromModel($user);
```

The flags [PARTIAL][link-flag-partial], [IGNORE_UNKNOWN_PROPERTIES][link-flag-ignore] and [CAST_PRIMITIVES][link-flag-cast] are applied to the DTO when it is instantiated from a model. [Additional flags][link-flags] can be passed as second parameter.

---

Finally, the method `from()` instantiates a DTO from several interfaces (specific to Laravel or not), including:

- `Illuminate\Support\Enumerable`
- `Illuminate\Contracts\Support\Arrayable`
- `Illuminate\Contracts\Support\Jsonable`
- `JsonSerializable`
- `Traversable`
- any value that can be casted into an array

In this case no flags are applied by default, but they can still be passed as second parameter.


### Resolve a DTO

As long as [PARTIAL][link-flag-partial] is set in the default flags of a DTO, such DTO can be automatically resolved by the Laravel IoC container with the data carried by the current application request:

```php
use App\Dtos\UserData;
use App\Http\Controllers\Controller;

class UserController extends Controller
{
    public function store(UserData $dto)
    {
        // ...
    }
}
```


### Convert into DTO

Another way to get an instance of DTO from different objects is letting them use the trait `TurnsIntoDto` and call the method `toDto()`:

```php
use Cerbero\LaravelDto\Traits\TurnsIntoDto;

class StoreUserRequest extends Request
{
    use TurnsIntoDto;
}

class User extends Model
{
    use TurnsIntoDto;

    protected $dtoClass = UserData::class;
}

class Example
{
    use TurnsIntoDto;

    protected function getDtoClass(): ?string
    {
        return $condition ? UserData::class : OtherDto::class;
    }
}

$dto = $request->toDto(UserData::class, MUTABLE);
$dto = $user->toDto(CAST_PRIMITIVES);
$dto = $example->toDto();
```

Classes using the trait can specify the DTO to turn into by:
- passing the DTO class name as first parameter of the method `toDto()`
- defining the property `$dtoClass`
- overriding the method `getDtoClass()` if custom logic is needed

Flags can optionally be passed as second parameter, or first parameter if the DTO class is already defined in the class using the trait. When models turn into DTOs, the flag [CAST_PRIMITIVES][link-flag-cast] is added to help casting values if casts are not defined on the Eloquent models.


### Convert into array

By default Laravel DTO registers a [value converter][link-value-converter] for `Carbon` instances. When a DTO is converted into array, all its `Carbon` objects are turned into an atom string and then converted back into `Carbon` instances when a new DTO is instantiated:

```php
$dto = UserData::make(['created_at' => '2000-01-01']);
$dto->createdAt; // Carbon instance
$data = $dto->toArray(); // ['created_at' => '2000-01-01T00:00:00+00:00']

$dto = UserData::make($data);
$dto->createdAt; // Carbon instance
```

Conversions can be added or removed in the `config/dto.php` file, specifically via the key `conversions`:

```php
use Carbon\Carbon;
use Cerbero\LaravelDto\Manipulators\CarbonConverter;

return [
    'conversions' => [
        Carbon::class => CarbonConverter::class,
    ],
];
```


### Listen to events

The only feature added by this package to [listeners][link-listener] is the ability to resolve dependencies via the Laravel IoC container. Dependencies can be injected into listeners constructor to be automatically resolved.

Listeners can be added or removed in the `config/dto.php` file, specifically via the key `listeners`:

```php
return [
    'listeners' => [
        UserData::class => UserDataListener::class,
    ],
];
```


### Define flags globally

Sometimes we may want all our DTOs to share the same [flags][link-flags], an example might be the need to always work with mutable DTOs. An easy way to accomplish that is defining such flags in the `config/dto.php` file:

```php
return [
    'flags' => MUTABLE,
];
```


### Support for macros

In case we need to add functionalities to all DTOs, an option might be using macros. Please refer to the Laravel documentation to see an [example of how to register a macro][link-macros].


### DTO debugging

When using the helpers `dump()` or `dd()`, only DTOs data will be shown instead of all the underlying architecture that makes the package work:

```php
dd($dto);

// only DTO data is shown:

App\Dtos\UserData {#3224
  +name: "Phil"
}
```


## Change log

Please see [CHANGELOG](CHANGELOG.md) for more information on what has changed recently.


## Testing

```bash
composer test
```


## Contributing

Please see [CONTRIBUTING](CONTRIBUTING.md) and [CODE_OF_CONDUCT](CODE_OF_CONDUCT.md) for details.


## Security

If you discover any security related issues, please email andrea.marco.sartori@gmail.com instead of using the issue tracker.


## Credits

- [Andrea Marco Sartori][link-author]
- [All Contributors][link-contributors]


## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.

[ico-laravel]: https://img.shields.io/badge/Laravel-%E2%89%A5%205.6-ff2d20?style=flat-square&logo=laravel
[ico-php]: https://img.shields.io/packagist/php-v/cerbero/laravel-dto?color=%238892BF&style=flat-square&logo=php
[ico-version]: https://img.shields.io/packagist/v/cerbero/laravel-dto.svg?style=flat-square
[ico-license]: https://img.shields.io/badge/license-MIT-brightgreen.svg?style=flat-square
[ico-travis]: https://img.shields.io/travis/cerbero90/laravel-dto/master.svg?style=flat-square&logo=travis
[ico-scrutinizer]: https://img.shields.io/scrutinizer/coverage/g/cerbero90/laravel-dto.svg?style=flat-square&logo=scrutinizer
[ico-code-quality]: https://img.shields.io/scrutinizer/g/cerbero90/laravel-dto.svg?style=flat-square&logo=scrutinizer
[ico-downloads]: https://img.shields.io/packagist/dt/cerbero/laravel-dto.svg?style=flat-square

[link-packagist]: https://packagist.org/packages/cerbero/laravel-dto
[link-travis]: https://travis-ci.org/cerbero90/laravel-dto
[link-scrutinizer]: https://scrutinizer-ci.com/g/cerbero90/laravel-dto/code-structure
[link-code-quality]: https://scrutinizer-ci.com/g/cerbero90/laravel-dto
[link-downloads]: https://packagist.org/packages/cerbero/laravel-dto
[link-dto]: https://github.com/cerbero90/dto
[link-data-transfer-object]: https://github.com/rexlabsio/data-transfer-object
[link-dto-init]: https://github.com/cerbero90/dto#instantiate-a-dto
[link-flags]: https://github.com/cerbero90/dto#available-flags
[link-flag-partial]: https://github.com/cerbero90/dto#partial
[link-flag-ignore]: https://github.com/cerbero90/dto#ignore_unknown_properties
[link-flag-cast]: https://github.com/cerbero90/dto#cast_primitives
[link-value-converter]: https://github.com/cerbero90/dto#convert-into-array
[link-listener]: https://github.com/cerbero90/dto#listen-to-events
[link-macros]: https://laravel.com/docs/collections#extending-collections
[link-author]: https://github.com/cerbero90
[link-lachlan]: https://github.com/lachlankrautz
[link-repo]: https://github.com/rexlabsio/data-transfer-object
[link-contributors]: ../../contributors